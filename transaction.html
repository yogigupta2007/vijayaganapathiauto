<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --bg:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --gold:#f59e0b; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{ margin:0; min-height:100svh; display:grid; place-items:center; background:#0b1020; color:var(--text); padding:16px; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap{ width:100%; max-width:420px; }
    .card{ background:#0a1020; border:1px solid rgba(148,163,184,.15); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.45); overflow:hidden; }
    .hdr{ padding:16px 18px; border-bottom:1px solid rgba(148,163,184,.12); }
    .hdr h1{ margin:0; font-size:18px; }
    .scratch-area{ position:relative; padding:18px; }
    .prize{ position:relative; border-radius:14px; background:linear-gradient(180deg,rgba(2,6,23,.9),rgba(2,6,23,.85)); border:1px solid rgba(148,163,184,.18); padding:28px 20px; text-align:center; overflow:hidden; }
    .label{ font-size:14px; color:var(--muted); margin-bottom:8px; }
    .amount{ font-size:40px; line-height:1.1; font-weight:800; color:var(--gold); text-shadow:0 2px 12px rgba(245,158,11,.25); }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    canvas.scratcher{ position:absolute; inset:18px; width:calc(100% - 36px); height:auto; aspect-ratio:16/9; border-radius:14px; display:block; touch-action:none; z-index:10; }
    .state{ padding:0 18px 18px 18px; color:var(--muted); font-size:13px; }
    .err{ color:#fda4af; }
    code.small{ font-size:12px; color:#9ca3af; word-break:break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hdr"><h1>Vijayaganapthi Auto</h1></div>

      <div class="scratch-area">
        <div class="prize" id="prize">
          <div class="label" id="label">Scratch to reveal</div>
          <div class="amount" id="amount">₹ — — —</div>
          <div class="status">Status: <span id="statusText">—</span></div>
        </div>
        <canvas class="scratcher" id="scratcher"></canvas>
      </div>

      <div class="state" id="stateMsg">Loading…</div>
    </div>
  </div>

  <script type="module">
    // === CONFIG: REPLACE THESE ===
    const SUPABASE_URL = 'https://qwwwiknpaypvahgdwrlc.supabase.co'; // replace
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3d3dpa25wYXlwdmFoZ2R3cmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTQ1OTUsImV4cCI6MjA3NDAzMDU5NX0.xqmg68pzmthq8qvoPjxhVvAz6w_AYzFOF13iZxF1e2Q'; // replace
    // ==================================================
    const TABLE = 'Scratchcards';
    const COL = { assignedTo:'assigned_to', prizeAmount:'prize_amount', status:'status' };

    const qs = new URLSearchParams(location.search);
    const linkId = qs.get('id'); // ?id=VALUE

    const $ = (id) => document.getElementById(id);
    const amountEl = $('amount'), labelEl=$('label'), statusEl=$('statusText'), stateEl=$('stateMsg'), canvas=$('scratcher');

    const fmtINR = (n) => {
      try { return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(Number(n||0)); }
      catch { return '₹ ' + Number(n||0).toLocaleString('en-IN'); }
    };

    // Size canvas to prize and paint gray sheet
    function sizeCanvasToPrize(canvasEl) {
      const prize = document.getElementById('prize');
      const pad = 18;
      const rect = prize.getBoundingClientRect();

      const innerWidth = Math.max(0, rect.width - (pad * 2));
      const innerHeight = Math.max(Math.round(innerWidth / (16/9)), 160);

      canvasEl.style.inset = `${pad}px ${pad}px ${pad}px ${pad}px`;
      canvasEl.style.width = `${innerWidth}px`;
      canvasEl.style.height = `${innerHeight}px`;

      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvasEl.width = Math.floor(innerWidth * dpr);
      canvasEl.height = Math.floor(innerHeight * dpr);

      const ctx = canvasEl.getContext('2d', { willReadFrequently: true });
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
      ctx.fillStyle = '#b8c0cc'; // gray overlay
      ctx.fillRect(0, 0, innerWidth, innerHeight);
      ctx.fillStyle = '#6b7280';
      ctx.font = '700 20px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('Scratch here', innerWidth / 2, innerHeight / 2);
      ctx.globalCompositeOperation = 'destination-out'; // erase on draw
    }

    async function sbFetch(url, opts){ 
      const h = { apikey: SUPABASE_ANON_KEY, Authorization: 'Bearer '+SUPABASE_ANON_KEY, 'Content-Type':'application/json', ...(opts?.headers||{}) };
      const res = await fetch(url, { ...opts, headers: h });
      const text = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
      try { return JSON.parse(text); } catch { return text; }
    }

    function selectUrl(idVal){
      return `${SUPABASE_URL}/rest/v1/${TABLE}?select=${COL.prizeAmount},${COL.status},${COL.assignedTo}&${COL.assignedTo}=eq.${encodeURIComponent(idVal)}&limit=1`;
    }
    function patchUrl(idVal){
      return `${SUPABASE_URL}/rest/v1/${TABLE}?${COL.assignedTo}=eq.${encodeURIComponent(idVal)}`;
    }

    async function loadRow(idVal){
      const url = selectUrl(idVal);
      return sbFetch(url);
    }
    async function markUsed(idVal){
      const url = patchUrl(idVal);
      return sbFetch(url, { method:'PATCH', headers:{ Prefer:'return=representation' }, body: JSON.stringify({ [COL.status]:'Used' }) });
    }

    class Scratcher {
      constructor(canvas, { brush=26, threshold=0.5, onReveal=()=>{} }={}) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d', { willReadFrequently:true });
        this.brush = brush; this.threshold = threshold; this.onReveal = onReveal; this.down=false;
        this._start=this._start.bind(this); this._move=this._move.bind(this); this._end=this._end.bind(this);
        canvas.addEventListener('pointerdown', this._start);
        canvas.addEventListener('pointermove', this._move);
        canvas.addEventListener('pointerup', this._end);
        canvas.addEventListener('pointerleave', this._end);
      }
      _scratch(e){ const rect=this.canvas.getBoundingClientRect(); const x=(e.clientX ?? (e.touches&&e.touches[0].clientX))-rect.left; const y=(e.clientY ?? (e.touches&&e.touches[0].clientY))-rect.top; const c=this.ctx; c.beginPath(); c.arc(x,y,this.brush,0,Math.PI*2); c.fill(); }
      _check(){ const w=this.canvas.width,h=this.canvas.height,step=8,d=this.ctx.getImageData(0,0,w,h).data; let clr=0,tot=0; for(let y=0;y<h;y+=step){ for(let x=0;x<w;x+=step){ const a=d[((y*w+x)<<2)+3]; tot++; if(a===0) clr++; } } if(clr/tot>=this.threshold){ this.revealAll(); this.onReveal(); } }
      _start(e){ this.down=true; this._scratch(e); }
      _move(e){ if(!this.down) return; this._scratch(e); this._check(); }
      _end(){ this.down=false; this._check(); }
      revealAll(){ this.ctx.globalCompositeOperation='destination-out'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height); this.canvas.style.pointerEvents='none'; }
    }

    let row=null, revealed=false;

    async function init(){
      // Size and paint overlay first so it’s always visible
      await new Promise(r => requestAnimationFrame(()=>r()));
      sizeCanvasToPrize(canvas);
      window.addEventListener('resize', () => sizeCanvasToPrize(canvas));

      if (!linkId){
        stateEl.innerHTML = '<span class="err">Missing ?id in URL.</span>';
        return;
      }

      try{
        const arr = await loadRow(linkId);
        row = arr[0];
        if (!row){
          stateEl.innerHTML = '<span class="err">No record found for this link.</span>';
          return;
        }
        amountEl.textContent = fmtINR(row[COL.prizeAmount]);
        statusEl.textContent = String(row[COL.status] ?? '');
        stateEl.textContent = 'Scratch the card to reveal your reward.';

        const scratcher = new Scratcher(canvas, {
          brush:26, threshold:0.5,
          onReveal: async () => {
            if (revealed) return;
            revealed = true;
            labelEl.textContent = 'Reward revealed';
            stateEl.textContent = 'Updating status…';
            try{
              const updatedRows = await markUsed(row[COL.assignedTo]);
              const updated = Array.isArray(updatedRows) ? updatedRows[0] : null;
              statusEl.textContent = String(updated?.[COL.status] ?? 'Used');
              stateEl.textContent = 'Revealed.';
            }catch(e){
              console.error('PATCH error:', e);
              stateEl.innerHTML = '<span class="err">Could not update status. Please show this screen to staff.</span>';
            }
          }
        });
      }catch(e){
        console.error('GET error:', e);
        stateEl.innerHTML = '<span class="err">Error loading reward.</span>';
      }
    }
    init();
  </script>
</body>
</html>
